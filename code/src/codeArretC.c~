#include "codeArretC.h"
#include "extern_globals.h"

int code_arret_cam(void)
{

	static uint8_t nbZero = 0;
	static uint8_t nbLigneArrivee = 0;
	
	int8_t valeursDerivee[126];		
	uint8_t i; 
	uint8_t posMax = 0;
	uint8_t moyenne = 0;
	
	// Calcul de la dérivée, du maximum et de la moyenne
    for (i=0; i<126; i++) {
		 valeursDerivee[i] = camera_valeurs[i+1] - camera_valeurs[i];
		 posMax = (valeursDerivee[i] > valeursDerivee[posMax] ? i : posMax);
		 moyenne += camera_valeurs[i];		 
    }
    
    moyenne /= 127;
    
    // Seuil de considération (algorithme) = k1 * moyenne => incertitude
    /*
      k1 = 
          3/2 -> ?
    */

    if (camera_valeurs[posMax] > 3/2 * moyenne) {  
		
       // Detection des pics de la derivee
       for (i=0; i<126; i++) {
		  
		  // Seuil de considération (pic) = k2 * max => incertitude
    		  /*
		    k2 = 
	                3/4 -> ?
	          */ 

		  if (abs(valeursDerivee[i]) > 3/4*valeursDerivee[posMax]) {
			  nbZero++;	
                          i =+ 4;	
		  }	  
       }   
    
       // Detection des lignes d'arrivees intermediaires (au nombre de deux)
       if (nbZero >= 6) {
	   // nbLigneArrivee++;
           nbZero = 0;
           return 1; // provisoire   
       }
       /*
       // Detection de LA ligne d'arrivee
       if (nbLigneArrivee >= 3) {
	   nbLigneArrivee = 0;
           return 1;		   	   
       }
       */
    } 	
}
